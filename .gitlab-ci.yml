stages:
  - build-re-implementations

.before-bazel-builds: &before_bazel_builds
  - mkdir -p ~/.docker
  - "echo {\\\"auths\\\": {\\\"index.docker.io\\\": {\\\"auth\\\": \\\"`echo -n $DOCKER_USER:$DOCKER_PASS | base64`\\\"}}} > ~/.docker/config.json"
  - apt update && apt install -yq pkg-config zip g++ zlib1g-dev unzip python curl git
  - apt install -y openjdk-8-jdk
  - echo "deb [arch=amd64] http://storage.googleapis.com/bazel-apt stable jdk1.8" | tee /etc/apt/sources.list.d/bazel.list
  - curl https://bazel.build/bazel-release.pub.gpg | apt-key add -
  - apt update && apt install -y bazel

build-buildbarn-remote-execution:
  stage: build-re-implementations
  image: ubuntu:18.04
  before_script: *before_bazel_builds
  script:
    - git clone https://github.com/buildbarn/bb-remote-execution
    - |
      for service in bb_worker bb_scheduler bb_runner_ubuntu16_04 bb_runner_debian8; do
          service_folder=`echo $service | cut -d _ -f -2`
          (cd bb-remote-execution && bazel build //cmd/${service_folder}:${service}_container_push)
          sed -i bb-remote-execution/bazel-bin/cmd/${service_folder}/${service}_container_push -e "s#index.docker.io/buildbarn/\(.*\):{BUILD_SCM_TIMESTAMP}-{BUILD_SCM_REVISION}#index.docker.io/remoteapistesting/\1:$CI_PIPELINE_ID#"
          bash bb-remote-execution/bazel-bin/cmd/${service_folder}/${service}_container_push
      done

.build-buildbarn-template: &build-buildbarn-template
  stage: build-re-implementations
  image: ubuntu:18.04
  before_script: *before_bazel_builds
  script:
    - git clone $REPO $SERVICE
    - (cd ${SERVICE} && bazel build //cmd/${SERVICE}:${SERVICE}_container_push)
    - sed -i ${SERVICE}/bazel-bin/cmd/${SERVICE}/${SERVICE}_container_push -e "s#index.docker.io/buildbarn/\(.*\):{BUILD_SCM_TIMESTAMP}-{BUILD_SCM_REVISION}#index.docker.io/remoteapistesting/\1:$CI_PIPELINE_ID#"
    - bash ${SERVICE}/bazel-bin/cmd/${SERVICE}/${SERVICE}_container_push

build-buildbarn-storage:
  variables:
    REPO: https://github.com/buildbarn/bb-storage
    SERVICE: bb_storage
  <<: *build-buildbarn-template
